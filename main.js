/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var z=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var K=(r,e)=>{for(var n in e)z(r,n,{get:e[n],enumerable:!0})},ee=(r,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let l of Y(e))!k.call(r,l)&&l!==n&&z(r,l,{get:()=>e[l],enumerable:!(t=Q(e,l))||t.enumerable});return r};var ne=r=>ee(z({},"__esModule",{value:!0}),r);var ue={};K(ue,{default:()=>S});module.exports=ne(ue);var m=require("@codemirror/view"),A=require("obsidian"),G=require("@codemirror/state");function p(){}p.prototype={diff:function(e,n){var t,l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=l.callback;typeof l=="function"&&(i=l,l={});var o=this;function u(d){return d=o.postProcess(d,l),i?(setTimeout(function(){i(d)},0),!0):d}e=this.castInput(e,l),n=this.castInput(n,l),e=this.removeEmpty(this.tokenize(e,l)),n=this.removeEmpty(this.tokenize(n,l));var a=n.length,c=e.length,s=1,f=a+c;l.maxEditLength!=null&&(f=Math.min(f,l.maxEditLength));var h=(t=l.timeout)!==null&&t!==void 0?t:1/0,w=Date.now()+h,v=[{oldPos:-1,lastComponent:void 0}],g=this.extractCommon(v[0],n,e,0,l);if(v[0].oldPos+1>=c&&g+1>=a)return u(R(o,v[0].lastComponent,n,e,o.useLongestToken));var L=-1/0,x=1/0;function O(){for(var d=Math.max(L,-s);d<=Math.min(x,s);d+=2){var y=void 0,b=v[d-1],F=v[d+1];b&&(v[d-1]=void 0);var W=!1;if(F){var j=F.oldPos-d;W=F&&0<=j&&j<a}var J=b&&b.oldPos+1<c;if(!W&&!J){v[d]=void 0;continue}if(!J||W&&b.oldPos<F.oldPos?y=o.addToPath(F,!0,!1,0,l):y=o.addToPath(b,!1,!0,1,l),g=o.extractCommon(y,n,e,d,l),y.oldPos+1>=c&&g+1>=a)return u(R(o,y.lastComponent,n,e,o.useLongestToken));v[d]=y,y.oldPos+1>=c&&(x=Math.min(x,d-1)),g+1>=a&&(L=Math.max(L,d+1))}s++}if(i)(function d(){setTimeout(function(){if(s>f||Date.now()>w)return i();O()||d()},0)})();else for(;s<=f&&Date.now()<=w;){var T=O();if(T)return T}},addToPath:function(e,n,t,l,i){var o=e.lastComponent;return o&&!i.oneChangePerToken&&o.added===n&&o.removed===t?{oldPos:e.oldPos+l,lastComponent:{count:o.count+1,added:n,removed:t,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+l,lastComponent:{count:1,added:n,removed:t,previousComponent:o}}},extractCommon:function(e,n,t,l,i){for(var o=n.length,u=t.length,a=e.oldPos,c=a-l,s=0;c+1<o&&a+1<u&&this.equals(t[a+1],n[c+1],i);)c++,a++,s++,i.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return s&&!i.oneChangePerToken&&(e.lastComponent={count:s,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=a,c},equals:function(e,n,t){return t.comparator?t.comparator(e,n):e===n||t.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],t=0;t<e.length;t++)e[t]&&n.push(e[t]);return n},castInput:function(e){return e},tokenize:function(e){return Array.from(e)},join:function(e){return e.join("")},postProcess:function(e){return e}};function R(r,e,n,t,l){for(var i=[],o;e;)i.push(e),o=e.previousComponent,delete e.previousComponent,e=o;i.reverse();for(var u=0,a=i.length,c=0,s=0;u<a;u++){var f=i[u];if(f.removed)f.value=r.join(t.slice(s,s+f.count)),s+=f.count;else{if(!f.added&&l){var h=n.slice(c,c+f.count);h=h.map(function(w,v){var g=t[s+v];return g.length>w.length?g:w}),f.value=r.join(h)}else f.value=r.join(n.slice(c,c+f.count));c+=f.count,f.added||(s+=f.count)}}return i}var re=new p;function Z(r,e,n){return re.diff(r,e,n)}function B(r,e){var n;for(n=0;n<r.length&&n<e.length;n++)if(r[n]!=e[n])return r.slice(0,n);return r.slice(0,n)}function P(r,e){var n;if(!r||!e||r[r.length-1]!=e[e.length-1])return"";for(n=0;n<r.length&&n<e.length;n++)if(r[r.length-(n+1)]!=e[e.length-(n+1)])return r.slice(-n);return r.slice(-n)}function D(r,e,n){if(r.slice(0,e.length)!=e)throw Error("string ".concat(JSON.stringify(r)," doesn't start with prefix ").concat(JSON.stringify(e),"; this is a bug"));return n+r.slice(e.length)}function M(r,e,n){if(!e)return r+n;if(r.slice(-e.length)!=e)throw Error("string ".concat(JSON.stringify(r)," doesn't end with suffix ").concat(JSON.stringify(e),"; this is a bug"));return r.slice(0,-e.length)+n}function C(r,e){return D(r,e,"")}function E(r,e){return M(r,e,"")}function _(r,e){return e.slice(0,te(r,e))}function te(r,e){var n=0;r.length>e.length&&(n=r.length-e.length);var t=e.length;r.length<e.length&&(t=r.length);var l=Array(t),i=0;l[0]=0;for(var o=1;o<t;o++){for(e[o]==e[i]?l[o]=l[i]:l[o]=i;i>0&&e[o]!=e[i];)i=l[i];e[o]==e[i]&&i++}i=0;for(var u=n;u<r.length;u++){for(;i>0&&r[u]!=e[i];)i=l[i];r[u]==e[i]&&i++}return i}var H="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",ie=new RegExp("[".concat(H,"]+|\\s+|[^").concat(H,"]"),"ug"),I=new p;I.equals=function(r,e,n){return n.ignoreCase&&(r=r.toLowerCase(),e=e.toLowerCase()),r.trim()===e.trim()};I.tokenize=function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n;if(e.intlSegmenter){if(e.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(e.intlSegmenter.segment(r),function(i){return i.segment})}else n=r.match(ie)||[];var t=[],l=null;return n.forEach(function(i){/\s/.test(i)?l==null?t.push(i):t.push(t.pop()+i):/\s/.test(l)?t[t.length-1]==l?t.push(t.pop()+i):t.push(l+i):t.push(i),l=i}),t};I.join=function(r){return r.map(function(e,n){return n==0?e:e.replace(/^\s+/,"")}).join("")};I.postProcess=function(r,e){if(!r||e.oneChangePerToken)return r;var n=null,t=null,l=null;return r.forEach(function(i){i.added?t=i:i.removed?l=i:((t||l)&&X(n,l,t,i),n=i,t=null,l=null)}),(t||l)&&X(n,l,t,null),r};function X(r,e,n,t){if(e&&n){var l=e.value.match(/^\s*/)[0],i=e.value.match(/\s*$/)[0],o=n.value.match(/^\s*/)[0],u=n.value.match(/\s*$/)[0];if(r){var a=B(l,o);r.value=M(r.value,o,a),e.value=C(e.value,a),n.value=C(n.value,a)}if(t){var c=P(i,u);t.value=D(t.value,u,c),e.value=E(e.value,c),n.value=E(n.value,c)}}else if(n)r&&(n.value=n.value.replace(/^\s*/,"")),t&&(t.value=t.value.replace(/^\s*/,""));else if(r&&t){var s=t.value.match(/^\s*/)[0],f=e.value.match(/^\s*/)[0],h=e.value.match(/\s*$/)[0],w=B(s,f);e.value=C(e.value,w);var v=P(C(s,w),h);e.value=E(e.value,v),t.value=D(t.value,s,v),r.value=M(r.value,s,s.slice(0,s.length-v.length))}else if(t){var g=t.value.match(/^\s*/)[0],L=e.value.match(/\s*$/)[0],x=_(L,g);e.value=E(e.value,x)}else if(r){var O=r.value.match(/\s*$/)[0],T=e.value.match(/^\s*/)[0],d=_(O,T);e.value=C(e.value,d)}}var le=new p;le.tokenize=function(r){var e=new RegExp("(\\r?\\n)|[".concat(H,"]+|[^\\S\\n\\r]+|[^").concat(H,"]"),"ug");return r.match(e)||[]};var $=new p;$.tokenize=function(r,e){e.stripTrailingCr&&(r=r.replace(/\r\n/g,`
`));var n=[],t=r.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(var l=0;l<t.length;l++){var i=t[l];l%2&&!e.newlineIsToken?n[n.length-1]+=i:n.push(i)}return n};$.equals=function(r,e,n){return n.ignoreWhitespace?((!n.newlineIsToken||!r.includes(`
`))&&(r=r.trim()),(!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(r.endsWith(`
`)&&(r=r.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),p.prototype.equals.call(this,r,e,n)};var oe=new p;oe.tokenize=function(r){return r.split(/(\S.+?[.!?])(?=\s+|$)/)};var ae=new p;ae.tokenize=function(r){return r.split(/([{}:;,]|\s+)/)};function U(r){return U=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},U(r)}var N=new p;N.useLongestToken=!0;N.tokenize=$.tokenize;N.castInput=function(r,e){var n=e.undefinedReplacement,t=e.stringifyReplacer,l=t===void 0?function(i,o){return typeof o=="undefined"?n:o}:t;return typeof r=="string"?r:JSON.stringify(V(r,null,null,l),l,"  ")};N.equals=function(r,e,n){return p.prototype.equals.call(N,r.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"),n)};function V(r,e,n,t,l){e=e||[],n=n||[],t&&(r=t(l,r));var i;for(i=0;i<e.length;i+=1)if(e[i]===r)return n[i];var o;if(Object.prototype.toString.call(r)==="[object Array]"){for(e.push(r),o=new Array(r.length),n.push(o),i=0;i<r.length;i+=1)o[i]=V(r[i],e,n,t,l);return e.pop(),n.pop(),o}if(r&&r.toJSON&&(r=r.toJSON()),U(r)==="object"&&r!==null){e.push(r),o={},n.push(o);var u=[],a;for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&u.push(a);for(u.sort(),i=0;i<u.length;i+=1)a=u[i],o[a]=V(r[a],e,n,t,a);e.pop(),n.pop()}else o=r;return o}var q=new p;q.tokenize=function(r){return r.slice()};q.join=q.removeEmpty=function(r){return r};var S=class extends A.Plugin{constructor(){super(...arguments);this.userColors={};this.decorations=m.Decoration.none}async onload(){let n=this;this.registerEditorExtension(m.ViewPlugin.fromClass(class{constructor(t){this.decorations=m.Decoration.none;this.decorations=m.Decoration.none,this.updateDecorations(t)}update(t){(t.docChanged||t.viewportChanged)&&this.updateDecorations(t.view)}async updateDecorations(t){this.decorations=await n.buildDecorations(t)}},{decorations:t=>t.decorations}))}async getFileVersions(n){let t=app.internalPlugins.plugins.sync;if(!t)return[];let l=n.view.file;if(!l)return[];let i=await t.instance.getHistory(l.path);if(!i)return[];let o=new TextDecoder("utf-8");return await Promise.all(i.items.map(async a=>{let c=await t.instance.getContentForVersion(a.uid);return{user:a.device,content:o.decode(c)}}))}getUserColor(n){if(!this.userColors[n]){let t=0;for(let i=0;i<n.length;i++)t=n.charCodeAt(i)+((t<<5)-t);let l=`#${((t&16777215)<<0).toString(16).padStart(6,"0")}`;this.userColors[n]=l}return this.userColors[n]}findNextChangeIndex(n,t){let l=n.map(o=>o.user),i=l[t];for(let o=t+1;o<l.length;o++)if(l[o]!=i)return o;return n.length}getCharFromUser(n){let t="_";return n==="bean_machine"?t="b":n==="Bident-of-Thassa.local"&&(t="T"),t}replace_chars(n,t,l,i){return l+i>n.length&&(n+="_".repeat(l+i-n.length)),n.slice(0,l)+t.repeat(i)+n.slice(l+i,n.length)}getSegmentFromHistory(n){let t=[],l=0;for(;l!=n.length;){let o=this.findNextChangeIndex(n,l);t.push(o),l=o}t.push(n.length);let i="";for(let o=0;o<t.length-1;o++){let u=n[t[o]-1],a=n[t[o+1]-1];if(u.user!==a.user){let c=Z(u.content,a.content),s=0;c.forEach(f=>{if(f.added){let h=this.getCharFromUser(a.user);i=this.replace_chars(i,h,s,f.count),s+=f.count}else if(f.removed)i=this.replace_chars(i,"",s,f.count),s-=f.count;else{let h=this.getCharFromUser(u.user);i=this.replace_chars(i,h,s,f.count),s+=f.count}})}}return i}convert_segment_to_groups(n){let t={b:this.getUserColor("bean"),T:this.getUserColor("Bident"),_:this.getUserColor("underscore")};t.b="red",t.T="blue";let l=[{start:0,end:1,color:t[n[0]],char:n[0]}];for(let i=1;i<n.length;i++)l[l.length-1].char===n[i]?l[l.length-1].end+=1:l.push({start:i,end:i+1,color:t[n[i]],char:n[i]});return l}async buildDecorations(n){var u;let t=(u=app.workspace.getActiveViewOfType(A.MarkdownView))==null?void 0:u.leaf;if(!t)return m.Decoration.none;let l=await this.getFileVersions(t);if(!l||l.length===0)return m.Decoration.none;let i=new G.RangeSetBuilder,o=n.state.doc.toString();if(l.length>1){l.reverse();let a=this.getSegmentFromHistory(l);this.convert_segment_to_groups(a).forEach(s=>{i.add(s.start,s.end,m.Decoration.mark({attributes:{style:`background-color: ${s.color}; opacity: 0.5;`}}))})}return i.finish()}};
